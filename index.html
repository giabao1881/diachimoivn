<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi ƒê·ªãa Ch·ªâ H√†nh Ch√≠nh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header-section h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .header-section .lead {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
        }
        
        .card-header-custom {
            background: white;
            border-bottom: 3px solid var(--secondary-color);
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-color);
            padding: 20px;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .btn-custom-primary {
            background: var(--secondary-color);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .btn-custom-primary:hover {
            background: var(--primary-color);
            transform: scale(1.05);
        }
        
        .btn-custom-success {
            background: var(--success-color);
            border: none;
            padding: 10px 25px;
            font-weight: 600;
            border-radius: 10px;
        }
        
        .status-success {
            background-color: #d4edda !important;
            color: #155724;
        }
        
        .status-warning {
            background-color: #fff3cd !important;
            color: #856404;
        }
        
        .status-error {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        
        .data-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .example-address {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            border-radius: 0 10px 10px 0;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .stat-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }
            
            .header-section {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <h1><i class="bi bi-geo-alt-fill"></i> C√îNG C·ª§ CHUY·ªÇN ƒê·ªîI ƒê·ªäA CH·ªà</h1>
            <p class="lead">Chuy·ªÉn ƒë·ªïi h√†ng lo·∫°t t·ª´ c·∫•u tr√∫c c≈© (T·ªânh ‚Üí Huy·ªán ‚Üí X√£) sang c·∫•u tr√∫c m·ªõi (T·ªânh ‚Üí X√£)</p>
            <div class="mt-4">
                <span class="badge bg-light text-dark me-2"><i class="bi bi-check-circle"></i> Mi·ªÖn ph√≠</span>
                <span class="badge bg-light text-dark me-2"><i class="bi bi-lightning"></i> X·ª≠ l√Ω nhanh</span>
                <span class="badge bg-light text-dark"><i class="bi bi-download"></i> Xu·∫•t CSV/Excel</span>
            </div>
        </div>

        <!-- Ph·∫ßn ch√≠nh -->
        <div class="container-fluid p-4">
            <!-- Tr·∫°ng th√°i d·ªØ li·ªáu -->
            <div id="dataStatus" class="data-status">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
                <p class="mt-2 mb-0">ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªãa ch·ªâ Vi·ªát Nam...</p>
            </div>

            <!-- B∆∞·ªõc 1: H∆∞·ªõng d·∫´n -->
            <div class="card card-custom">
                <div class="card-header card-header-custom">
                    <div class="d-flex align-items-center">
                        <span class="step-badge">1</span>
                        <span>H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</span>
                    </div>
                </div>
                <div class="card-body">
                    <p>Nh·∫≠p danh s√°ch ƒë·ªãa ch·ªâ c·∫ßn chuy·ªÉn ƒë·ªïi. <strong>M·ªói ƒë·ªãa ch·ªâ tr√™n m·ªôt d√≤ng</strong>, theo m·ªôt trong c√°c ƒë·ªãnh d·∫°ng sau:</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="example-address">
                                <strong>ƒê·ªãnh d·∫°ng 1:</strong><br>
                                T·ªânh A, Huy·ªán X, X√£ 1
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="example-address">
                                <strong>ƒê·ªãnh d·∫°ng 2:</strong><br>
                                T·ªânh A - Huy·ªán X - X√£ 1
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="example-address">
                                <strong>ƒê·ªãnh d·∫°ng 3:</strong><br>
                                T·ªânh A Huy·ªán X X√£ 1
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p><strong>V√≠ d·ª• c·ª• th·ªÉ:</strong></p>
                        <pre class="bg-light p-3 rounded">H√† N·ªôi, Qu·∫≠n Ba ƒê√¨nh, Ph∆∞·ªùng Tr√∫c B·∫°ch
TP. H·ªì Ch√≠ Minh - Qu·∫≠n 1 - Ph∆∞·ªùng B·∫øn Ngh√©
ƒê√† N·∫µng Huy·ªán H√≤a Vang X√£ H√≤a Phong
Th√°i Nguy√™n, Th√†nh ph·ªë Th√°i Nguy√™n, Ph∆∞·ªùng T√¢n L·∫≠p</pre>
                    </div>
                </div>
            </div>

            <!-- B∆∞·ªõc 2: Nh·∫≠p d·ªØ li·ªáu -->
            <div class="card card-custom">
                <div class="card-header card-header-custom">
                    <div class="d-flex align-items-center">
                        <span class="step-badge">2</span>
                        <span>NH·∫¨P D·ªÆ LI·ªÜU V√Ä CHUY·ªÇN ƒê·ªîI</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label for="inputAddresses" class="form-label fw-bold">
                            <i class="bi bi-card-text"></i> Danh s√°ch ƒë·ªãa ch·ªâ c·∫ßn chuy·ªÉn ƒë·ªïi:
                        </label>
                        <textarea class="form-control" id="inputAddresses" rows="8" 
                                  placeholder="D√°n ho·∫∑c nh·∫≠p danh s√°ch ƒë·ªãa ch·ªâ c·ªßa b·∫°n v√†o ƒë√¢y...&#10;M·ªói ƒë·ªãa ch·ªâ tr√™n m·ªôt d√≤ng."></textarea>
                        <div class="form-text">H·ªó tr·ª£ c·∫£ ti·∫øng Vi·ªát c√≥ d·∫•u v√† kh√¥ng d·∫•u. T·ª± ƒë·ªông nh·∫≠n di·ªán ƒë·ªãnh d·∫°ng.</div>
                    </div>
                    
                    <div class="progress-container" style="display: none;" id="progressContainer">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="progressText">ƒêang x·ª≠ l√Ω...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap justify-content-between align-items-center mt-4">
                        <div>
                            <button id="btnConvert" class="btn btn-custom-primary me-2" disabled>
                                <i class="bi bi-arrow-repeat"></i> B·∫ÆT ƒê·∫¶U CHUY·ªÇN ƒê·ªîI
                            </button>
                            <button id="btnReset" class="btn btn-outline-secondary">
                                <i class="bi bi-trash"></i> X√ìA T·∫§T C·∫¢
                            </button>
                        </div>
                        <div class="text-end">
                            <div class="stat-box">
                                <div class="stat-number" id="lineCount">0</div>
                                <div class="stat-label">D√íNG D·ªÆ LI·ªÜU</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B∆∞·ªõc 3: K·∫øt qu·∫£ -->
            <div class="card card-custom">
                <div class="card-header card-header-custom">
                    <div class="d-flex align-items-center">
                        <span class="step-badge">3</span>
                        <span>K·∫æT QU·∫¢ CHUY·ªÇN ƒê·ªîI</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultStats" class="alert alert-info" style="display: none;">
                        <i class="bi bi-info-circle-fill"></i> <span id="resultText"></span>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="resultTable" class="table table-hover w-100" style="display: none;">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50">#</th>
                                    <th>ƒê·ªäA CH·ªà C≈® (NH·∫¨P V√ÄO)</th>
                                    <th>T·ªàNH/TH√ÄNH M·ªöI</th>
                                    <th>QU·∫¨N/HUY·ªÜN C≈®</th>
                                    <th>X√É/PH∆Ø·ªúNG M·ªöI</th>
                                    <th width="120">TR·∫†NG TH√ÅI</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="exportSection" style="display: none;" class="mt-4">
                        <div class="d-flex flex-wrap gap-2">
                            <button id="btnExportCSV" class="btn btn-custom-success">
                                <i class="bi bi-file-earmark-spreadsheet"></i> T·∫¢I XU·ªêNG CSV
                            </button>
                            <button id="btnExportExcel" class="btn btn-success">
                                <i class="bi bi-file-excel"></i> T·∫¢I XU·ªêNG EXCEL
                            </button>
                            <button id="btnCopyTable" class="btn btn-outline-primary">
                                <i class="bi bi-clipboard"></i> SAO CH√âP B·∫¢NG
                            </button>
                            <button id="btnPrint" class="btn btn-outline-secondary">
                                <i class="bi bi-printer"></i> IN K·∫æT QU·∫¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Th√¥ng tin d·ª± √°n -->
            <div class="mt-5 pt-4 border-top text-center text-muted">
                <p>
                    <strong>C√¥ng c·ª• chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ h√†nh ch√≠nh Vi·ªát Nam</strong><br>
                    D·ªØ li·ªáu c·∫≠p nh·∫≠t 2025 | Ch·∫°y ho√†n to√†n tr√™n tr√¨nh duy·ªát | Kh√¥ng l∆∞u tr·ªØ d·ªØ li·ªáu
                </p>
                <p class="small">
                    S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ <code>vn-address-data.json</code> | 
                    <span id="dataInfo">ƒêang t·∫£i th√¥ng tin d·ªØ li·ªáu...</span>
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Script ch√≠nh -->
    <script>
        // ==================== KHAI B√ÅO BI·∫æN ====================
        let addressData = null;
        let dataLoaded = false;
        let currentResults = [];

        // ==================== T·∫¢I D·ªÆ LI·ªÜU ====================
        async function loadAddressData() {
            try {
                console.log("üîÑ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ vn-address-data.json...");
                
                const response = await fetch('./vn-address-data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Kh√¥ng th·ªÉ t·∫£i file d·ªØ li·ªáu`);
                }
                
                addressData = await response.json();
                dataLoaded = true;
                
                // C·∫≠p nh·∫≠t giao di·ªán
                $('#dataStatus').html(`
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">D·ªØ li·ªáu ƒë√£ s·∫µn s√†ng!</h5>
                            <p class="mb-0">ƒê√£ t·∫£i th√†nh c√¥ng ${addressData.data?.length || 0} t·ªânh/th√†nh ph·ªë</p>
                        </div>
                    </div>
                `);
                
                $('#btnConvert').prop('disabled', false);
                $('#dataInfo').text(`D·ªØ li·ªáu: ${addressData.data?.length || 0} t·ªânh/th√†nh`);
                
                console.log(`‚úÖ ƒê√£ t·∫£i ${addressData.data?.length || 0} t·ªânh/th√†nh`);
                
            } catch (error) {
                console.error('‚ùå L·ªói t·∫£i d·ªØ li·ªáu:', error);
                
                $('#dataStatus').html(`
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">L·ªói t·∫£i d·ªØ li·ªáu!</h5>
                            <p class="mb-0">${error.message}. Vui l√≤ng ki·ªÉm tra file vn-address-data.json</p>
                        </div>
                    </div>
                `);
            }
        }

        // ==================== H√ÄM TI·ªÜN √çCH ====================
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd')
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== T√ÅCH ƒê·ªäA CH·ªà ====================
        function parseAddressLine(line) {
            line = line.trim();
            if (!line) return null;
            
            // Th·ª≠ t√°ch b·∫±ng d·∫•u ph·∫©y
            let parts = line.split(/[,]/).map(p => p.trim()).filter(p => p);
            if (parts.length >= 3) {
                return {
                    raw: line,
                    province: parts[0],
                    district: parts[1],
                    ward: parts.slice(2).join(', ') // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p x√£ c√≥ nhi·ªÅu ph·∫ßn
                };
            }
            
            // Th·ª≠ t√°ch b·∫±ng d·∫•u g·∫°ch ngang
            parts = line.split(/[-\u2013\u2014]/).map(p => p.trim()).filter(p => p);
            if (parts.length >= 3) {
                return {
                    raw: line,
                    province: parts[0],
                    district: parts[1],
                    ward: parts.slice(2).join(' - ')
                };
            }
            
            // T√°ch b·∫±ng t·ª´ kh√≥a
            const patterns = [
                /(t·ªânh|th√†nh ph·ªë|tp\.?)\s*(.+?)\s*(huy·ªán|qu·∫≠n|th·ªã x√£|tx\.?)\s*(.+?)\s*(x√£|ph∆∞·ªùng|th·ªã tr·∫•n|tt\.?)\s*(.+)/i,
                /(.+?)\s+(huy·ªán|qu·∫≠n)\s+(.+?)\s+(x√£|ph∆∞·ªùng)\s+(.+)/i
            ];
            
            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    return {
                        raw: line,
                        province: match[1] + ' ' + match[2],
                        district: match[3] + ' ' + match[4],
                        ward: match[5] + ' ' + match[6]
                    };
                }
            }
            
            // T√°ch ƒë∆°n gi·∫£n b·∫±ng kho·∫£ng tr·∫Øng (l·∫•y 2-3-3 t·ª´)
            const words = line.split(/\s+/);
            if (words.length >= 6) {
                return {
                    raw: line,
                    province: words.slice(0, 2).join(' '),
                    district: words.slice(2, 4).join(' '),
                    ward: words.slice(4).join(' ')
                };
            } else if (words.length >= 3) {
                // Gi·∫£ ƒë·ªãnh 1-1-1 t·ª´
                return {
                    raw: line,
                    province: words[0],
                    district: words[1],
                    ward: words.slice(2).join(' ')
                };
            }
            
            return {
                raw: line,
                province: line,
                district: '',
                ward: ''
            };
        }

        // ==================== T√åM ƒê·ªäA CH·ªà ====================
        function findAddressInData(provinceInput, districtInput, wardInput) {
            if (!dataLoaded || !addressData?.data) {
                return { status: 'D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng' };
            }
            
            const normProvince = normalizeText(provinceInput);
            const normDistrict = normalizeText(districtInput);
            const normWard = normalizeText(wardInput);
            
            // T√¨m t·ªânh
            for (const province of addressData.data) {
                const normProvinceName = normalizeText(province.name);
                
                // So kh·ªõp t·ªânh
                if (normProvince.includes(normProvinceName) || 
                    normProvinceName.includes(normProvince) ||
                    normProvince.includes('thanh pho ' + normProvinceName) ||
                    normProvince.includes('tinh ' + normProvinceName)) {
                    
                    // T√¨m x√£ trong t·ªânh (c·∫•u tr√∫c m·ªõi)
                    if (province.wards && province.wards.length > 0) {
                        for (const ward of province.wards) {
                            const normWardName = normalizeText(ward.name);
                            
                            // So kh·ªõp x√£
                            if (normWard.includes(normWardName) || 
                                normWardName.includes(normWard) ||
                                (normDistrict && normWardName.includes(normalizeText(normDistrict + ' ' + normWard)))) {
                                
                                return {
                                    status: 'Th√†nh c√¥ng',
                                    province: province.name,
                                    ward: ward.name,
                                    code: ward.code
                                };
                            }
                        }
                        
                        // Kh√¥ng t√¨m th·∫•y x√£ ph√π h·ª£p
                        return {
                            status: 'T√¨m th·∫•y t·ªânh, kh√¥ng kh·ªõp x√£',
                            province: province.name,
                            ward: '',
                            code: ''
                        };
                    }
                    
                    // T·ªânh kh√¥ng c√≥ x√£
                    return {
                        status: 'T·ªânh kh√¥ng c√≥ d·ªØ li·ªáu x√£',
                        province: province.name,
                        ward: '',
                        code: ''
                    };
                }
            }
            
            return { status: 'Kh√¥ng t√¨m th·∫•y t·ªânh' };
        }

        // ==================== X·ª¨ L√ù CHUY·ªÇN ƒê·ªîI ====================
        function processAddresses() {
            if (!dataLoaded) {
                alert('Vui l√≤ng ƒë·ª£i d·ªØ li·ªáu t·∫£i xong!');
                return;
            }
            
            const inputText = $('#inputAddresses').val().trim();
            if (!inputText) {
                alert('Vui l√≤ng nh·∫≠p danh s√°ch ƒë·ªãa ch·ªâ!');
                return;
            }
            
            const lines = inputText.split('\n').filter(line => line.trim() !== '');
            const total = lines.length;
            
            if (total === 0) {
                alert('Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o ƒë·ªÉ x·ª≠ l√Ω!');
                return;
            }
            
            // Hi·ªÉn th·ªã thanh ti·∫øn tr√¨nh
            $('#progressContainer').show();
            $('#progressText').text(`ƒêang x·ª≠ l√Ω 0/${total} ƒë·ªãa ch·ªâ...`);
            $('#progressBar').css('width', '0%');
            $('#progressPercent').text('0%');
            
            currentResults = [];
            let processed = 0;
            
            // H√†m x·ª≠ l√Ω t·ª´ng ƒë·ªãa ch·ªâ
            function processNext() {
                if (processed >= total) {
                    // Ho√†n th√†nh
                    displayResults();
                    $('#progressContainer').hide();
                    return;
                }
                
                const line = lines[processed];
                const parsed = parseAddressLine(line);
                
                if (parsed) {
                    const result = findAddressInData(parsed.province, parsed.district, parsed.ward);
                    
                    currentResults.push({
                        index: processed + 1,
                        original: parsed.raw,
                        provinceOld: parsed.province,
                        districtOld: parsed.district,
                        wardOld: parsed.ward,
                        provinceNew: result.province || '',
                        wardNew: result.ward || '',
                        status: result.status || 'L·ªói',
                        code: result.code || ''
                    });
                } else {
                    currentResults.push({
                        index: processed + 1,
                        original: line,
                        provinceOld: '',
                        districtOld: '',
                        wardOld: '',
                        provinceNew: '',
                        wardNew: '',
                        status: 'Kh√¥ng th·ªÉ ph√¢n t√≠ch',
                        code: ''
                    });
                }
                
                processed++;
                
                // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
                const percent = Math.round((processed / total) * 100);
                $('#progressBar').css('width', percent + '%');
                $('#progressPercent').text(percent + '%');
                $('#progressText').text(`ƒêang x·ª≠ l√Ω ${processed}/${total} ƒë·ªãa ch·ªâ...`);
                
                // Ti·∫øp t·ª•c v·ªõi ƒë·ªãa ch·ªâ ti·∫øp theo
                setTimeout(processNext, 10);
            }
            
            // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω
            processNext();
        }

        // ==================== HI·ªÇN TH·ªä K·∫æT QU·∫¢ ====================
        function displayResults() {
            const tableBody = $('#resultBody');
            tableBody.empty();
            
            let successCount = 0;
            let warningCount = 0;
            let errorCount = 0;
            
            // Th√™m d·ªØ li·ªáu v√†o b·∫£ng
            currentResults.forEach(result => {
                // ƒê·∫øm s·ªë l∆∞·ª£ng theo tr·∫°ng th√°i
                if (result.status === 'Th√†nh c√¥ng') successCount++;
                else if (result.status.includes('Kh√¥ng t√¨m th·∫•y') || result.status.includes('L·ªói') || result.status.includes('Kh√¥ng th·ªÉ ph√¢n t√≠ch')) errorCount++;
                else warningCount++;
                
                // X√°c ƒë·ªãnh class CSS cho d√≤ng
                let rowClass = '';
                let statusClass = '';
                let statusIcon = '';
                
                if (result.status === 'Th√†nh c√¥ng') {
                    rowClass = 'status-success';
                    statusClass = 'badge bg-success';
                    statusIcon = '<i class="bi bi-check-circle"></i> ';
                } else if (result.status.includes('Kh√¥ng t√¨m th·∫•y') || result.status.includes('L·ªói') || result.status.includes('Kh√¥ng th·ªÉ ph√¢n t√≠ch')) {
                    rowClass = 'status-error';
                    statusClass = 'badge bg-danger';
                    statusIcon = '<i class="bi bi-x-circle"></i> ';
                } else {
                    rowClass = 'status-warning';
                    statusClass = 'badge bg-warning text-dark';
                    statusIcon = '<i class="bi bi-exclamation-triangle"></i> ';
                }
                
                const row = `
                    <tr class="${rowClass}">
                        <td class="fw-bold">${result.index}</td>
                        <td><small>${escapeHtml(result.original)}</small></td>
                        <td>${escapeHtml(result.provinceNew)}</td>
                        <td>${escapeHtml(result.districtOld)}</td>
                        <td>${escapeHtml(result.wardNew)} ${result.code ? `<small class="text-muted">(${result.code})</small>` : ''}</td>
                        <td><span class="${statusClass}">${statusIcon}${result.status}</span></td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
            
            // Hi·ªÉn th·ªã th·ªëng k√™
            const total = currentResults.length;
            const successRate = total > 0 ? Math.round((successCount / total) * 100) : 0;
            
            $('#resultText').html(`
                <strong>ƒê√É X·ª¨ L√ù ${total} ƒê·ªäA CH·ªà:</strong> 
                <span class="text-success">${successCount} th√†nh c√¥ng</span> | 
                <span class="text-warning">${warningCount} c·∫£nh b√°o</span> | 
                <span class="text-danger">${errorCount} l·ªói</span>
                <span class="float-end">T·ª∑ l·ªá th√†nh c√¥ng: <strong>${successRate}%</strong></span>
            `);
            
            $('#resultStats').show();
            
            // Kh·ªüi t·∫°o DataTable
            if ($.fn.DataTable.isDataTable('#resultTable')) {
                $('#resultTable').DataTable().destroy();
            }
            
            $('#resultTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[0, 'asc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
                },
                dom: '<"top"fl>rt<"bottom"ip><"clear">'
            }).show();
            
            // Hi·ªÉn th·ªã n√∫t xu·∫•t
            $('#exportSection').show();
            
            // Cu·ªôn ƒë·∫øn k·∫øt qu·∫£
            $('html, body').animate({
                scrollTop: $('#exportSection').offset().top - 100
            }, 500);
        }

        // ==================== XU·∫§T D·ªÆ LI·ªÜU ====================
        function exportToCSV() {
            const headers = ['STT', 'ƒê·ªãa ch·ªâ c≈©', 'T·ªânh/Th√†nh m·ªõi', 'Qu·∫≠n/Huy·ªán c≈©', 'X√£/Ph∆∞·ªùng m·ªõi', 'M√£', 'Tr·∫°ng th√°i'];
            
            const rows = currentResults.map(result => [
                result.index,
                result.original,
                result.provinceNew,
                result.districtOld,
                result.wardNew,
                result.code || '',
                result.status
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `ket_qua_chuyen_doi_${new Date().getTime()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportToExcel() {
            const wsData = [
                ['K·∫æT QU·∫¢ CHUY·ªÇN ƒê·ªîI ƒê·ªäA CH·ªà'],
                ['Th·ªùi gian:', new Date().toLocaleString('vi-VN')],
                [''],
                ['STT', 'ƒê·ªãa ch·ªâ c≈©', 'T·ªânh/Th√†nh m·ªõi', 'Qu·∫≠n/Huy·ªán c≈©', 'X√£/Ph∆∞·ªùng m·ªõi', 'M√£', 'Tr·∫°ng th√°i']
            ];
            
            currentResults.forEach(result => {
                wsData.push([
                    result.index,
                    result.original,
                    result.provinceNew,
                    result.districtOld,
                    result.wardNew,
                    result.code || '',
                    result.status
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£');
            
            // Merge c√°c √¥ ti√™u ƒë·ªÅ
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } });
            ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 1 } });
            
            XLSX.writeFile(wb, `ket_qua_chuyen_doi_${new Date().getTime()}.xlsx`);
        }

        function copyTableToClipboard() {
            const table = $('#resultTable').clone();
            table.find('.dataTables_empty').remove();
            
            const html = table.prop('outerHTML');
            navigator.clipboard.writeText(html).then(() => {
                alert('ƒê√£ sao ch√©p b·∫£ng k·∫øt qu·∫£ v√†o clipboard!');
            }).catch(err => {
                console.error('L·ªói sao ch√©p:', err);
                alert('Kh√¥ng th·ªÉ sao ch√©p v√†o clipboard.');
            });
        }

        // ==================== S·ª∞ KI·ªÜN ====================
        $(document).ready(function() {
            // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c m·ªü
            loadAddressData();
            
            // ƒê·∫øm s·ªë d√≤ng nh·∫≠p v√†o
            $('#inputAddresses').on('input', function() {
                const lines = $(this).val().trim().split('\n').filter(line => line.trim() !== '');
                $('#lineCount').text(lines.length);
            });
            
            // N√∫t chuy·ªÉn ƒë·ªïi
            $('#btnConvert').click(processAddresses);
            
            // N√∫t reset
            $('#btnReset').click(function() {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) {
                    $('#inputAddresses').val('');
                    $('#lineCount').text('0');
                    $('#resultStats').hide();
                    $('#resultTable').hide();
                    $('#exportSection').hide();
                    $('#progressContainer').hide();
                }
            });
            
            // N√∫t xu·∫•t CSV
            $('#btnExportCSV').click(exportToCSV);
            
            // N√∫t xu·∫•t Excel
            $('#btnExportExcel').click(exportToExcel);
            
            // N√∫t sao ch√©p b·∫£ng
            $('#btnCopyTable').click(copyTableToClipboard);
            
            // N√∫t in
            $('#btnPrint').click(function() {
                window.print();
            });
            
            // Ph√≠m t·∫Øt
            $(document).keydown(function(e) {
                // Ctrl+Enter ƒë·ªÉ chuy·ªÉn ƒë·ªïi
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    $('#btnConvert').click();
                }
                
                // Esc ƒë·ªÉ reset
                if (e.key === 'Escape') {
                    $('#btnReset').click();
                }
            });
            
            // Tooltip
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
</body>
</html>
